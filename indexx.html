<!DOCTYPE html>
<html>
<head>
  <title>üõ°Ô∏èSecure V Local</title>
  <link rel="icon" type="image/png" href="/whoareyou/indexicon.png">
  <style>
    /* üé® WARNA KHUSUS UNTUKMU */
    :root {
      --glow: #00ff88;
      --dark: #0a0a12;
      --error: #ff0033;
      --success: #00ff88;
      --scan-speed: 3s;
    }

    /* üñ•Ô∏è TAMPILAN UTAMA */
    body {
      background: radial-gradient(circle at center, #0a0a20, #000000);
      height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Courier New', monospace;
      color: var(--glow);
      overflow: hidden;
    }

    .vault {
      width: 320px;
      height: 420px;
      background: rgba(10,10,20,0.9);
      border-radius: 16px;
      border: 1px solid var(--glow);
      box-shadow: 
        0 0 30px rgba(0,255,136,0.2),
        inset 0 0 20px rgba(0,255,136,0.1);
      position: relative;
      overflow: hidden;
    }

    /* üñêÔ∏è FINGERPRINT SCANNER */
    .fingerprint {
      width: 160px;
      height: 200px;
      margin: 30px auto;
      background: 
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 120"><path d="M15,20 Q50,0 85,20 Q95,40 85,60 Q75,80 50,90 Q25,80 15,60 Q5,40 15,20" fill="none" stroke="%2300ff88" stroke-width="0.5" stroke-dasharray="2,1"/></svg>') center/contain no-repeat;
      position: relative;
      filter: drop-shadow(0 0 5px var(--glow));
      cursor: pointer;
    }

    .ridges {
      position: absolute;
      width: 100%;
      height: 100%;
      background: 
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 120"><path d="M10,15 Q50,-5 90,15 Q100,35 90,55 Q80,75 50,85 Q20,75 10,55 Q0,35 10,15" fill="none" stroke="%2300ff8833" stroke-width="0.3"/></svg>') center/contain no-repeat;
    }

    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(to bottom, transparent, var(--glow), transparent);
      animation: scan var(--scan-speed) linear infinite;
      opacity: 0;
      z-index: 2;
    }

    .scan-highlight {
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, transparent 70%, rgba(0,255,136,0.1) 100%);
      opacity: 0;
      z-index: 1;
    }

    .scan-dots {
      position: absolute;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 30% 20%, var(--glow) 1px, transparent 1px),
        radial-gradient(circle at 70% 40%, var(--glow) 1px, transparent 1px),
        radial-gradient(circle at 20% 60%, var(--glow) 1px, transparent 1px),
        radial-gradient(circle at 80% 80%, var(--glow) 1px, transparent 1px);
      background-size: 100% 100%;
      opacity: 0;
      z-index: 3;
    }

    /* üö® DARURAT MODE */
    .under-attack {
      animation: attack-pulse 0.8s infinite;
    }

    /* üìü STATUS & KODE */
    .status {
      text-align: center;
      margin-top: 20px;
      height: 20px;
      font-size: 14px;
      text-shadow: 0 0 5px var(--glow);
    }

    .code-display {
      position: absolute;
      bottom: 70px;
      width: 90%;
      left: 5%;
      height: 60px;
      background: rgba(0,0,0,0.5);
      border: 1px dashed var(--glow);
      font-size: 10px;
      padding: 5px;
      overflow: hidden;
      display: none;
    }

    /* ‚ú® ANIMASI KHUSUS */
    @keyframes scan {
      0% { top: 0; opacity: 0; }
      5% { opacity: 1; }
      95% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }

    @keyframes highlight-pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.7; }
    }

    @keyframes dots-pulse {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.8; }
    }

    @keyframes attack-pulse {
      0%, 100% { box-shadow: 0 0 10px var(--error); }
      50% { box-shadow: 0 0 30px var(--error); }
    }

    @keyframes success-pulse {
      0%, 100% { box-shadow: 0 0 10px var(--success); }
      50% { box-shadow: 0 0 30px var(--success); }
    }

    .ip-display {
      position: absolute;
      bottom: 10px;
      width: 100%;
      text-align: center;
      font-size: 12px;
      color: rgba(0,255,136,0.7);
    }
    
    .progress-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: var(--glow);
      width: 0%;
      transition: width 0.1s linear;
    }
    
    .register-btn {
      background: transparent;
      border: 1px solid var(--glow);
      color: var(--glow);
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
    }
    
    .register-btn:hover {
      background: rgba(0, 255, 136, 0.1);
      box-shadow: 0 0 10px var(--glow);
    }
  </style>
</head>
<body>
  <div class="vault" id="vault">
    <div class="fingerprint" id="scanner">
      <div class="ridges"></div>
      <div class="scan-highlight" id="scanHighlight"></div>
      <div class="scan-dots" id="scanDots"></div>
      <div class="scan-line" id="scanLine"></div>
      <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <div class="status" id="status">FINGERPRINT AUTHENTICATION</div>
    
    <div class="code-display" id="codeDisplay"></div>
    
    <button class="register-btn" id="registerBtn">REGISTER FINGERPRINT</button>
  </div>
  
  <div class="ip-display" id="ipDisplay">
    Your IP: Loading...
  </div>

  <!-- Include Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
<script>
    // ======================
    // üß© MAIN CONFIGURATION
    // ======================
    const config = {
      maxAttempts: 3,
      scanDuration: 3000,
      secretCode: "LOCALLIFE",
      attemptCookieExpiry: 10, // minutes
      scanPoints: [
        {x: 30, y: 20, time: 0.1},
        {x: 70, y: 40, time: 0.3},
        {x: 20, y: 60, time: 0.5},
        {x: 80, y: 80, time: 0.7},
        {x: 50, y: 50, time: 0.9}
      ],
      supabaseUrl: 'YOUR_SUPABASE_URL',
      supabaseKey: 'YOUR_SUPABASE_ANON_KEY'
    };

    // ======================
    // üéõÔ∏è SYSTEM INITIALIZATION
    // ======================
    const vault = document.getElementById('vault');
    const scanner = document.getElementById('scanner');
    const scanLine = document.getElementById('scanLine');
    const scanHighlight = document.getElementById('scanHighlight');
    const scanDots = document.getElementById('scanDots');
    const progressBar = document.getElementById('progressBar');
    const status = document.getElementById('status');
    const registerBtn = document.getElementById('registerBtn');
    const codeDisplay = document.getElementById('codeDisplay');
    const ipDisplay = document.getElementById('ipDisplay');

    let isScanning = false;
    let isLocked = false;
    let audioCtx;
    let scanProgress = 0;
    let supabaseClient;
    
    // Initialize Supabase
    function initSupabase() {
      supabaseClient = supabase.createClient(config.supabaseUrl, config.supabaseKey);
      checkUserRegistration();
    }

    // ======================
    // üîê WEBAUTHN FUNCTIONS
    // ======================
    async function registerFingerprint() {
      try {
        startScan();
        status.textContent = "READY TO REGISTER FINGERPRINT...";
        
        // Generate a random user ID
        const userId = generateUserId();
        
        // WebAuthn registration options
        const publicKeyCredentialCreationOptions = {
          challenge: Uint8Array.from(
            window.crypto.getRandomValues(new Uint8Array(32))
            .buffer,
          rp: {
            name: "Secure V Local",
            id: window.location.hostname,
          },
          user: {
            id: Uint8Array.from(userId, c => c.charCodeAt(0)),
            name: userId,
            displayName: "Secure User",
          },
          pubKeyCredParams: [
            { type: "public-key", alg: -7 },  // ES256
            { type: "public-key", alg: -257 }, // RS256
          ],
          authenticatorSelection: {
            authenticatorAttachment: "platform",
            userVerification: "required",
          },
          timeout: 60000,
          attestation: "direct"
        };
        
        // Register the credential
        const credential = await navigator.credentials.create({
          publicKey: publicKeyCredentialCreationOptions
        });
        
        // Convert credential to transportable format
        const attestationObject = new Uint8Array(credential.response.attestationObject);
        const clientDataJSON = new Uint8Array(credential.response.clientDataJSON);
        const rawId = new Uint8Array(credential.rawId);
        
        // Send credential to Supabase
        const { data, error } = await supabaseClient
          .from('user_credentials')
          .insert([{
            user_id: userId,
            credential_id: Array.from(rawId),
            public_key: credential.id,
            attestation_object: Array.from(attestationObject),
            client_data_json: Array.from(clientDataJSON),
            device_type: getDeviceType()
          }]);
        
        if (error) throw error;
        
        // Success
        finishScan(true);
        status.textContent = "FINGERPRINT REGISTERED!";
        vault.classList.add('success-pulse');
        setTimeout(() => {
          vault.classList.remove('success-pulse');
          status.textContent = "READY FOR AUTHENTICATION";
        }, 2000);
        
      } catch (error) {
        console.error("Registration error:", error);
        finishScan(false);
        status.textContent = "REGISTRATION FAILED";
        setTimeout(() => status.textContent = "TRY AGAIN", 1500);
      }
    }
    
    async function authenticateFingerprint() {
      try {
        startScan();
        
        // Get the user's credentials from Supabase
        const { data: credentials, error } = await supabaseClient
          .from('user_credentials')
          .select('*');
        
        if (error) throw error;
        if (!credentials || credentials.length === 0) {
          registerBtn.style.display = 'block';
          throw new Error("No credentials found");
        }
        
        // Convert credential IDs to expected format
        const allowedCredentials = credentials.map(cred => ({
          id: Uint8Array.from(cred.credential_id),
          type: 'public-key',
          transports: ['internal']
        }));
        
        // WebAuthn authentication options
        const publicKeyCredentialRequestOptions = {
          challenge: Uint8Array.from(
            window.crypto.getRandomValues(new Uint8Array(32))
            .buffer,
          allowCredentials: allowedCredentials,
          userVerification: "required",
          timeout: 60000
        };
        
        // Authenticate the user
        const assertion = await navigator.credentials.get({
          publicKey: publicKeyCredentialRequestOptions
        });
        
        // Verify the assertion with Supabase
        const { data: user, error: authError } = await supabaseClient
          .from('user_credentials')
          .select('user_id')
          .eq('credential_id', Array.from(new Uint8Array(assertion.rawId)))
          .single();
        
        if (authError) throw authError;
        
        // Success
        finishScan(true);
        status.textContent = "AUTHENTICATION SUCCESS!";
        vault.classList.add('success-pulse');
        
        // Redirect to dashboard after successful auth
        setTimeout(() => {
          window.location.href = 'dashboard/index.html';
        }, 1000);
        
      } catch (error) {
        console.error("Authentication error:", error);
        finishScan(false);
        const attemptCount = updateAttemptCount();
        
        if (attemptCount >= config.maxAttempts) {
          triggerLockdown();
        } else {
          status.textContent = `AUTHENTICATION FAILED (${attemptCount}/${config.maxAttempts})`;
          setTimeout(() => {
            status.textContent = "READY FOR AUTHENTICATION";
            registerBtn.style.display = 'block';
          }, 1500);
        }
      }
    }
    
    function checkUserRegistration() {
      // Check if user has registered credentials
      supabaseClient
        .from('user_credentials')
        .select('*')
        .then(({ data, error }) => {
          if (!error && data && data.length > 0) {
            status.textContent = "READY FOR AUTHENTICATION";
          } else {
            status.textContent = "REGISTER FINGERPRINT";
            registerBtn.style.display = 'block';
          }
        });
    }
    
    function generateUserId() {
      return 'user_' + Math.random().toString(36).substring(2, 15);
    }
    
    function getDeviceType() {
      const ua = navigator.userAgent;
      if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry/.test(ua)) {
        return 'mobile';
      }
      return 'desktop';
    }

    // ======================
    // üç™ COOKIE MANAGEMENT
    // ======================
    function setCookie(name, value, minutes) {
      const date = new Date();
      date.setTime(date.getTime() + (minutes * 60 * 1000));
      document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
    }

    function getCookie(name) {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [cookieName, cookieValue] = cookie.trim().split('=');
        if (cookieName === name) return cookieValue;
      }
      return null;
    }

    function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/`;
    }

    // ======================
    // üîÑ ATTEMPT MANAGEMENT
    // ======================
    function getAttemptCount() {
      const attempts = getCookie('login_attempts');
      return attempts ? parseInt(attempts) : 0;
    }

    function updateAttemptCount() {
      const newCount = getAttemptCount() + 1;
      setCookie('login_attempts', newCount, config.attemptCookieExpiry);
      return newCount;
    }

    function resetAttempts() {
      deleteCookie('login_attempts');
    }

    // ======================
    // üîä AUDIO SYSTEM
    // ======================
    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playBeep(freq, dur, type='sine') {
      initAudio();
      
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      
      osc.type = type;
      osc.frequency.value = freq;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
      osc.stop(audioCtx.currentTime + dur);
    }

    function playBinaryNoise() {
      initAudio();
      
      const bufferSize = 2 * audioCtx.sampleRate;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      
      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() > 0.9 ? (Math.random() > 0.5 ? 0.5 : -0.5) : 0;
      }
      
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;
      
      const filter = audioCtx.createBiquadFilter();
      filter.type = "bandpass";
      filter.frequency.value = 2000;
      filter.Q.value = 1.0;
      
      const gain = audioCtx.createGain();
      gain.gain.value = 0.1;
      
      noise.connect(filter);
      filter.connect(gain);
      gain.connect(audioCtx.destination);
      
      noise.start();
      
      return noise;
    }

    // ======================
    // üîí SCAN ANIMATIONS
    // ======================
    function startScan() {
      isScanning = true;
      scanProgress = 0;
      status.textContent = "SCANNING...";
      scanLine.style.opacity = "1";
      scanHighlight.style.opacity = "0.3";
      scanHighlight.style.animation = "highlight-pulse 0.5s infinite";
      scanDots.style.opacity = "0.2";
      scanDots.style.animation = "dots-pulse 0.7s infinite";
      playBeep(800, 0.3);
      
      const binaryNoise = playBinaryNoise();
      
      const progressInterval = setInterval(() => {
        scanProgress += 1;
        progressBar.style.width = `${scanProgress}%`;
        
        if (Math.random() > 0.7) {
          const point = config.scanPoints[Math.floor(Math.random() * config.scanPoints.length)];
          scanner.style.background = 
            `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 120"><path d="M15,20 Q50,0 85,20 Q95,40 85,60 Q75,80 50,90 Q25,80 15,60 Q5,40 15,20" fill="none" stroke="%2300ff88" stroke-width="0.5" stroke-dasharray="2,1"/></svg>') center/contain no-repeat, 
            radial-gradient(circle at ${point.x}% ${point.y}%, rgba(0,255,136,0.3) 0%, transparent 70%)`;
        }
      }, config.scanDuration / 100);
      
      return {
        stop: () => {
          clearInterval(progressInterval);
          binaryNoise.stop();
        }
      };
    }

    function finishScan(success) {
      isScanning = false;
      scanLine.style.opacity = "0";
      scanHighlight.style.opacity = "0";
      scanHighlight.style.animation = "none";
      scanDots.style.opacity = "0";
      scanDots.style.animation = "none";
      progressBar.style.width = "0%";
      scanner.style.background = 
        `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 120"><path d="M15,20 Q50,0 85,20 Q95,40 85,60 Q75,80 50,90 Q25,80 15,60 Q5,40 15,20" fill="none" stroke="%2300ff88" stroke-width="0.5" stroke-dasharray="2,1"/></svg>') center/contain no-repeat`;
      
      if (success) {
        playBeep(1000, 0.5);
      } else {
        playBeep(400, 0.2);
      }
    }

    // ======================
    // üö® LOCKDOWN SYSTEM
    // ======================
    function triggerLockdown() {
      isLocked = true;
      status.textContent = "SECURITY LOCKDOWN";
      vault.classList.add('under-attack');
      
      setCookie('blocked', 'true', 1);
      resetAttempts();
      
      playBeep(200, 0.2, 'square');
      setTimeout(() => playBeep(150, 0.3, 'square'), 100);
      setTimeout(() => playBeep(100, 0.4, 'square'), 200);
      
      showEncryptionCode();
      setTimeout(() => window.location.href = 'whoareyou/index.html', 1000);
    }

    function showEncryptionCode() {
      codeDisplay.style.display = "block";
      codeDisplay.innerHTML = 
        `<span style="color:#ff5555">// ENCRYPTION ACTIVATED</span>\n` +
        `<span style="color:#00ff88">void</span> secure_decrypt() {\n` +
        `  <span style="color:#00ff88">if</span> (auth_attempts >= ${config.maxAttempts}) {\n` +
        `    <span style="color:#ff5555">firewall</span>(0x${Math.random().toString(16).slice(2,10)});\n` +
        `    <span style="color:#00ff88">return</span> <span style="color:#ff5555">LOCKDOWN</span>;\n` +
        `  }\n` +
        `}`;
    }

    // ======================
    // üéÆ SPECIAL FEATURES
    // ======================
    let keyBuffer = [];
    document.addEventListener('keydown', (e) => {
      keyBuffer.push(e.key.toUpperCase());
      if (keyBuffer.length > config.secretCode.length) {
        keyBuffer.shift();
      }
      
      if (keyBuffer.join('') === config.secretCode) {
        status.textContent = "DEVELOPER MODE ACTIVATED";
        vault.style.borderColor = "#ff00ff";
        playBeep(1000, 0.5);
        resetAttempts();
      }
    });

    // ======================
    // üöÄ INITIALIZATION
    // ======================
    function init() {
      if (getCookie('blocked')) {
        window.location.href = 'whoareyou/index.html';
        return;
      }

      // Initialize Supabase
      initSupabase();
      
      // Set up event listeners
      scanner.addEventListener('click', () => {
        if (!isScanning && !isLocked) {
          authenticateFingerprint();
        }
      });
      
      registerBtn.addEventListener('click', registerFingerprint);

      // Check device capabilities
      if (!window.PublicKeyCredential) {
        status.textContent = "FINGERPRINT AUTH NOT SUPPORTED";
        return;
      }

      fetch('https://api.ipify.org?format=json')
        .then(res => res.json())
        .then(data => {
          ipDisplay.textContent = `Your IP: ${data.ip}`;
        })
        .catch(() => {
          ipDisplay.textContent = 'Your IP: Unknown';
        });

      // Initialize audio on first interaction
      scanner.addEventListener('mousedown', initAudio, { once: true });
    }

    init();
</script>
</body>
</html>
