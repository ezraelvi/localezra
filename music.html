<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary: #8e44ad; --accent: #00a8ff; --success: #2ecc71;
            --danger: #e74c3c; --light: #ecf0f1; --dark: #1a1a2e;
            --bg-main: #16213e; --bg-panel: rgba(26, 26, 46, 0.9);
            --text-primary: #e0fbfc; --text-secondary: #98ded9;
            --border-color: rgba(0, 168, 255, 0.3);
        }
        html[data-theme='light'] {
            --primary: #3498db; --accent: #e67e22;
            --bg-main: #ecf0f1; --bg-panel: rgba(255, 255, 255, 0.9);
            --text-primary: #2c3e50; --text-secondary: #7f8c8d;
            --border-color: rgba(52, 152, 219, 0.4);
        }
        * { box-sizing: border-box; }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-main); color: var(--text-primary);
        }
        #interactive-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; background-color: var(--bg-main);
        }
        .main-container {
            position: relative; z-index: 1; width: 100%; height: 100%;
            transition: all 0.5s ease-in-out;
        }
        #map-wrapper {
            position: absolute; inset: 20px;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.5s ease-in-out;
        }
        #map-container {
            width: 100%; height: 100%; background: var(--bg-panel);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color); border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; overflow: hidden;
        }
        #map { flex-grow: 1; background-color: #333; }
        #locationInfo { padding: 10px; text-align: center; background: rgba(0,0,0,0.2); font-size: 0.9em; }
        .lock-screen {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; gap: 15px; height: 100%;
        }
        .hidden { display: none !important; }
        .panel {
            position: fixed; background: var(--bg-panel); backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px); z-index: 1010;
            box-shadow: 0 0 50px rgba(0,0,0,0.6);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex; flex-direction: column;
        }
        #editor-panel {
            top: 0; left: 0; width: 100%; height: 100%;
            transform: translateX(-100%);
        }
        #editor-panel.active { transform: translateX(0); }
        #music-panel {
            bottom: 0; left: 0; width: 100%; height: auto;
            max-height: 50vh; border-top: 1px solid var(--border-color);
            transform: translateY(100%); padding: 15px;
        }
        #music-panel.active { transform: translateY(0); }
        #contribution-panel {
            top: 0; right: 0; width: 400px; max-width: 90vw; height: 100%;
            transform: translateX(100%); padding: 20px;
        }
        #contribution-panel.active { transform: translateX(0); }
        /* New: Admin panel styling */
        #admin-panel {
            top: 50%;
            left: 50%;
            width: 400px; /* Adjust width as needed */
            max-width: 90vw;
            height: auto;
            max-height: 80vh; /* Limit height for scrollable content */
            transform: translate(-50%, -50%) scale(0.8);
            opacity: 0;
            pointer-events: none;
            border-radius: 15px;
            padding: 10px;
            overflow-y: auto; /* Enable scrolling for visitor list */
        }
        #admin-panel.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: all;
        }
        .panel-close-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            color: var(--text-primary); font-size: 1.5rem; cursor: pointer; z-index: 5;
        }
        .fab-container { position: fixed; z-index: 1000; }
        .fab {
            background: var(--primary); color: white; width: 55px; height: 55px;
            border-radius: 50%; border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.4rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        .fab:hover { background: var(--accent); transform: scale(1.1); }
        #fab-editor { top: 20px; left: 20px; }
        #fab-music { bottom: 20px; left: 50%; transform: translateX(-50%); }
        #fab-contribution { top: 20px; right: 20px; }
        #fab-layout, #fab-theme { bottom: 20px; }
        #fab-layout { left: 20px; }
        #fab-theme { right: 20px; }
        /* New: Admin FAB position (below private user FAB) */
        #fab-admin {
            left: 20px;
            top: calc(50% + 70px); /* Adjust based on private user fab height + spacing */
            transform: translateY(-50%);
        }
        #editor-panel { padding: 0; }
        .editor-toolbar { display: flex; gap: 5px; padding: 10px; background: rgba(0,0,0,0.2); flex-wrap: wrap; }
        .editor-toolbar button, .editor-toolbar select { background: var(--primary); color: white; border:none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .editor-main { display: flex; flex-grow: 1; height: calc(100% - 58px); }
        .editor-code-area, .editor-preview-area { flex: 1; display: flex; flex-direction: column; }
        .editor-panes { display: flex; flex-direction: column; flex-grow: 1; }
        .editor-pane { display: flex; flex-direction: column; flex-grow: 1; }
        .editor-pane label { background: #333; color: var(--accent); padding: 5px 10px; font-size: 0.8em; font-weight: bold;}
        .editor-pane textarea { flex-grow: 1; background: #1e1e1e; color: #f8f8f2; border: none; resize: none; padding: 10px; font-family: 'Courier New', monospace; font-size: 14px; outline: none; }
        #editor-preview { width: 100%; height: 100%; border: none; background: white; }
        #video-player-widget {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 999;
    width: 150px;
    height: 150px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.4);
    border: 2px solid var(--border-color);
}
#video-player-widget video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.video-controls {
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    background: rgba(0,0,0,0.5);
    padding: 5px;
    border-radius: 5px;
}
.video-controls button {
    background: none;
    border: none;
    color: white;
    font-size: 1rem;
    cursor: pointer;
}
    .social-links {
            position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; z-index: 999;
        }
        .social-links a { color: var(--text-primary); font-size: 1.5rem; transition: color 0.3s, transform 0.3s; }
        .social-links a:hover { color: var(--accent); transform: scale(1.2); }
        body.desktop-layout .main-container {
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            grid-template-rows: 1fr;
            gap: 20px; padding: 20px; height: 100vh;
        }
        body.desktop-layout #map-wrapper { position: static; }
        body.desktop-layout .panel {
            position: static; transform: none !important;
            height: auto; width: auto; max-height: none;
            box-shadow: 0 0 30px rgba(0,0,0,0.5); border: 1px solid var(--border-color);
            border-radius: 15px;
        }
        body.desktop-layout .panel-close-btn, 
        body.desktop-layout .fab, 
        body.desktop-layout .social-links { display: none; }
        body.desktop-layout .desktop-fab-bar {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; gap: 10px;
            background: var(--bg-panel); padding: 10px; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        /* Styling for the new private user button */
#fab-private-user {
    left: 20px; /* Position it on the left */
    top: 50%;
    transform: translateY(-50%); /* Center vertically */
}

/* Styling for the private user panel */
#private-user-panel {
    top: 50%;
    left: 50%;
    width: 300px; /* Adjust width as needed */
    max-width: 90vw;
    height: auto; /* Adjust height based on content */
    transform: translate(-50%, -50%) scale(0.8); /* Initially smaller and off-center */
    opacity: 0;
    pointer-events: none; /* Make it unclickable when not active */
    border-radius: 15px;
    padding: 10px; /* Add some padding to the panel */
}

#private-user-panel.active {
    transform: translate(-50%, -50%) scale(1); /* Full size and centered when active */
    opacity: 1;
    pointer-events: all; /* Make it clickable when active */
}

/* Adjust desktop layout to hide the new FAB */
body.desktop-layout #fab-private-user {
    display: none;
}
/* New: Hide Admin FAB in desktop layout */
body.desktop-layout #fab-admin {
    display: none;
}

/* Ensure desktop panel style for consistency */
body.desktop-layout #private-user-panel,
body.desktop-layout #admin-panel { /* Add admin panel here */
    position: static;
    transform: none !important;
    height: auto;
    width: auto;
    max-height: none;
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
    border: 1px solid var(--border-color);
    border-radius: 15px;
    opacity: 1; /* Always visible in desktop layout if implemented as a static panel */
    pointer-events: all;
}

/* Styling for visitor list within admin panel */
#visitor-list {
    list-style: none;
    padding: 0;
    margin: 0;
    color: var(--text-secondary);
}

#visitor-list li {
    background: rgba(0, 0, 0, 0.2);
    margin-bottom: 8px;
    padding: 10px;
    border-radius: 8px;
    font-size: 0.9em;
    border: 1px solid var(--border-color);
}

#visitor-list li strong {
    color: var(--text-primary);
}

#visitor-list li span {
    display: block;
    margin-top: 3px;
    color: var(--text-secondary);
    font-size: 0.85em;
}

    </style>
</head>
<body class=""> <canvas id="interactive-bg"></canvas> 
    <div class="main-container">
        <div id="map-wrapper">
            <div id="map-container">
                <div class="lock-screen" id="map-lock-screen">
                    <i class="fas fa-satellite fa-3x fa-spin" style="--fa-animation-duration: 5s; color: var(--accent);"></i>
                    <h3>REAL-TIME TRACKING SYSTEM</h3>
                    <p style="margin:0; color:var(--text-secondary);">System is offline. Type secret code to activate.</p>
                </div>
                <div id="map" class="hidden"></div>
                <div id="locationInfo" class="hidden">Initializing tracking...</div>
            </div>
        </div>
        <div class="panel" id="contribution-panel-desktop" style="display: none;">
             </div>
    </div>
    <div class="panel" id="editor-panel">
        <button class="panel-close-btn" data-panel="editor-panel"><i class="fas fa-times"></i></button>
        <div class="editor-toolbar">
            <button id="editor-run"><i class="fas fa-play"></i> Run</button>
            <button id="editor-save"><i class="fas fa-save"></i> Save</button>
            <button id="editor-load"><i class="fas fa-folder-open"></i> Load</button>
            <button id="editor-new"><i class="fas fa-file"></i> New</button>
            <button id="editor-add-media"><i class="fas fa-photo-video"></i> Add Media</button>
        </div>
        <div class="editor-main">
            <div class="editor-code-area">
                <div class="editor-panes">
                    <div class="editor-pane">
                        <label for="html-editor">HTML</label>
                        <textarea id="html-editor" spellcheck="false"></textarea>
                    </div>
                    <div class="editor-pane">
                        <label for="css-editor">CSS</label>
                        <textarea id="css-editor" spellcheck="false"></textarea>
                    </div>
                    <div class="editor-pane">
                        <label for="js-editor">JAVASCRIPT</label>
                        <textarea id="js-editor" spellcheck="false"></textarea>
                    </div>
                </div>
            </div>
            <div class="editor-preview-area">
                 <iframe id="editor-preview"></iframe>
            </div>
        </div>
    </div>
    <div class="panel" id="music-panel">
        <button class="panel-close-btn" data-panel="music-panel"><i class="fas fa-times"></i></button>
        <h4>Now Playing</h4>
        <div id="music-player-content">
            <h5 id="song-title">Select a song</h5>
            <audio id="audio-player" controls loop style="width: 100%;"></audio>
            <div id="playlist" style="max-height: 20vh; overflow-y: auto; margin-top: 10px;"></div>
        </div>
    </div>
    <div class="panel" id="contribution-panel">
        <button class="panel-close-btn" data-panel="contribution-panel"><i class="fas fa-times"></i></button>
        <div id="contribution-content" style="display: flex; flex-direction: column; height: 100%;">
            <h3 style="margin-top:20px;">Leave a Message</h3>
            <div id="contribution-display" style="flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 15px;">
                <p>Loading messages...</p>
            </div>
            <form id="contribution-form">
                <textarea id="contribution-text" placeholder="Your message..." required style="width:100%; min-height: 80px; background:rgba(0,0,0,0.2); color:var(--text-primary); border:1px solid var(--border-color); border-radius:5px; padding:10px;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                    <input type="file" id="contribution-file" accept="image/*,video/*" style="color:var(--text-secondary);">
                    <button type="submit" class="fab" style="position:static; width:45px; height:45px; font-size:1.1rem;"><i class="fas fa-paper-plane"></i></button>
                </div>
                <p id="contribution-status" style="font-size:0.9em; text-align:center; margin-top:10px;"></p>
            </form>
        </div>
    </div>
    <div class="fab-container" id="fab-private-user">
        <button class="fab" title="Private User"><i class="fas fa-user-secret"></i></button>
    </div>
    <div class="panel" id="private-user-panel">
        <button class="panel-close-btn" data-panel="private-user-panel"><i class="fas fa-times"></i></button>
        <div style="padding: 20px; text-align: center;">
            <h3 style="margin-bottom: 15px; color: var(--accent);">Private User</h3>
            <p style="margin-bottom: 20px;">Masuk sebagai siapa?</p>
            <input type="text" id="private-user-input" placeholder="Masukkan nama Anda..." style="width: 80%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.3); color: var(--text-primary); margin-bottom: 15px;">
            <button id="private-user-submit" class="fab" style="position:static; width:auto; padding: 10px 20px; font-size:1rem;">Masuk</button>
            <p id="private-user-message" style="margin-top: 15px; font-size: 0.9em;"></p>
        </div>
    </div>

    <div class="fab-container" id="fab-admin">
        <button class="fab" title="Admin Panel"><i class="fas fa-shield-alt"></i></button>
    </div>

    <div class="panel" id="admin-panel">
        <button class="panel-close-btn" data-panel="admin-panel"><i class="fas fa-times"></i></button>
        <div id="admin-auth-section" style="padding: 20px; text-align: center;">
            <h3 style="margin-bottom: 15px; color: var(--accent);">Masukkan Password Admin</h3>
            <input type="password" id="admin-password-input" placeholder="Password..." style="width: 80%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); background: rgba(0,0,0,0.3); color: var(--text-primary); margin-bottom: 15px;">
            <button id="admin-password-submit" class="fab" style="position:static; width:auto; padding: 10px 20px; font-size:1rem;">Masuk</button>
            <p id="admin-message" style="margin-top: 15px; font-size: 0.9em;"></p>
        </div>
        <div id="admin-content-section" class="hidden" style="flex-grow: 1; padding: 10px 20px;">
            <h3 style="margin-bottom: 15px; color: var(--accent);">Live Visitor List</h3>
            <ul id="visitor-list">
                <p style="text-align: center; color: var(--text-secondary);">Loading visitor data...</p>
            </ul>
        </div>
    </div>

    <div class="fab-container" id="fab-editor">
        <button class="fab" data-panel="editor-panel" title="Code Editor"><i class="fas fa-code"></i></button>
    </div>
    <div class="fab-container" id="fab-music">
        <button class="fab" data-panel="music-panel" title="Music Player"><i class="fas fa-music"></i></button>
    </div>
    <div class="fab-container" id="fab-contribution">
        <button class="fab" data-panel="contribution-panel" title="Leave a Message"><i class="fas fa-feather-alt"></i></button>
    </div>
    <div class="fab-container" id="fab-layout">
        <button class="fab" title="Toggle Layout"><i class="fas fa-layer-group"></i></button>
    </div>
    <div class="fab-container" id="fab-theme">
        <button class="fab" title="Toggle Theme"><i class="fas fa-sun"></i></button>
    </div>
    <div class="desktop-fab-bar" style="display:none;">
         <button class="fab" id="desktop-layout-toggle" title="Toggle Layout" style="position:static;"><i class="fas fa-mobile-alt"></i></button>
         <button class="fab" id="desktop-theme-toggle" title="Toggle Theme" style="position:static;"><i class="fas fa-sun"></i></button>
    </div>
    <div id="video-player-widget">
        <video id="widget-video" loop src="video.mp4"></video>
        <div class="video-controls">
            <button id="video-play-pause"><i class="fas fa-play"></i></button>
            <button id="video-mute"><i class="fas fa-volume-up"></i></button>
        </div>
    </div>
    <div class="social-links">
        <a href="https://wa.me/6281434046148" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
        <a href="https://instagram.com/ezravvv" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="https://github.com/ezraelvi/localezra" target="_blank" title="GitHub"><i class="fab fa-github"></i></a>
    </div>
<script>
const SECRET_CODE = "wherewe";
const CONTRIBUTIONS_WORKER_URL = 'https://contributions-workerjs.ezvvel.workers.dev/';
const VISITOR_TRACKER_WORKER_URL = 'https://visitor-tracker-workerjs.ezvvel.workers.dev/';
const ADMIN_AUTH_WORKER_URL = 'https://admin-auth-workerjs.ezvvel.workers.dev/'; // NEW: Admin Auth Worker URL
const LIVE_VISITORS_WORKER_URL = 'https://live-visitors-workerjs.ezvvel.workers.dev/'; // NEW: Live Visitors Worker URL

document.addEventListener('DOMContentLoaded', () => {
    initParticleBackground();
    initSecretCodeListener();
    initPanelControls();
    initLayoutAndThemeToggles();
    initVideoPlayer();
    initEditor();
    initMusicPlayer();
    trackVisitor(); // This function will send data to your visitor tracker worker
    initPrivateUserAuth();
    initAdminPanel(); // NEW: Initialize admin panel
});

function initParticleBackground() {
    const canvas = document.getElementById('interactive-bg');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let mouse = { x: null, y: null, radius: 150 };
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });
    window.addEventListener('mousemove', (event) => {
        mouse.x = event.x;
        mouse.y = event.y;
    });
    class Particle {
        constructor(x, y, dirX, dirY, size, color) {
            this.x = x; this.y = y; this.dirX = dirX; this.dirY = dirY;
            this.size = size; this.color = color;
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
            ctx.fillStyle = this.color;
            ctx.fill();
        }
        update() {
            if (this.x > canvas.width || this.x < 0) this.dirX = -this.dirX;
            if (this.y > canvas.height || this.y < 0) this.dirY = -this.dirY;
            this.x += this.dirX;
            this.y += this.dirY;
            this.draw();
        }
    }
    function initParticles() {
        particles = [];
        let numParticles = (canvas.height * canvas.width) / 9000;
        for (let i = 0; i < numParticles; i++) {
            let size = Math.random() * 2 + 1;
            let x = Math.random() * (innerWidth - size * 2);
            let y = Math.random() * (innerHeight - size * 2);
            let dirX = (Math.random() * .4) - .2;
            let dirY = (Math.random() * .4) - .2;
            let color = 'rgba(0, 168, 255, 0.8)';
            particles.push(new Particle(x, y, dirX, dirY, size, color));
        }
    }
    function connectParticles() {
        for (let a = 0; a < particles.length; a++) {
            for (let b = a; b < particles.length; b++) {
                let distance = ((particles[a].x - particles[b].x) * (particles[a].x - particles[b].x))
                             + ((particles[a].y - particles[b].y) * (particles[a].y - particles[b].y));
                if (distance < (canvas.width / 7) * (canvas.height / 7)) {
                    let opacity = 1 - (distance / 20000);
                    ctx.strokeStyle = `rgba(0, 168, 255, ${opacity})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(particles[a].x, particles[a].y);
                    ctx.lineTo(particles[b].x, particles[b].y);
                    ctx.stroke();
                }
            }
        }
    }
    function animateParticles() {
        requestAnimationFrame(animateParticles);
        ctx.clearRect(0, 0, innerWidth, innerHeight);
        particles.forEach(p => p.update());
        connectParticles();
    }
    initParticles();
    animateParticles();
}
let keySequence = [];
function initSecretCodeListener() {
    window.addEventListener('keydown', (e) => {
        keySequence.push(e.key.toLowerCase());
        keySequence = keySequence.slice(-SECRET_CODE.length);
        if (keySequence.join('') === SECRET_CODE) {
            unlockTrackingSystem();
            keySequence = [];
        }
    });
}
function unlockTrackingSystem() {
    const lockScreen = document.getElementById('map-lock-screen');
    if (!lockScreen.classList.contains('hidden')) {
        lockScreen.classList.add('hidden');
        document.getElementById('map').classList.remove('hidden');
        document.getElementById('locationInfo').classList.remove('hidden');
        getLocation();
        const info = document.getElementById('locationInfo');
        info.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success);"></i> System Activated. Initializing tracker...`;
    }
}
let map, marker;
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (pos) => initMap(pos.coords.latitude, pos.coords.longitude),
            () => initMap(2.4633, 97.9158, true), // Fallback to Subulussalam
            { enableHighAccuracy: true }
        );
    }
}
function initMap(lat, lon, isDefault = false) {
    if (!map) {
        map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CartoDB'
        }).addTo(map);
        marker = L.marker([lat, lon]).addTo(map);
    } else {
        map.setView([lat, lon]);
        marker.setLatLng([lat, lon]);
    }
    const locationInfoEl = document.getElementById('locationInfo');
    if (isDefault) {
        locationInfoEl.innerHTML = `Default Location: Subulussalam, Aceh`;
    } else {
        locationInfoEl.innerHTML = `Tracking... Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
    }
}

// Update initPanelControls to handle the new admin panel
function initPanelControls() {
    document.querySelectorAll('[data-panel]').forEach(button => {
        button.addEventListener('click', () => {
            const panelId = button.getAttribute('data-panel');
            const panel = document.getElementById(panelId);

            // If the panel is the admin panel, handle authentication first
            if (panelId === 'admin-panel') {
                const adminAuthSection = document.getElementById('admin-auth-section');
                const adminContentSection = document.getElementById('admin-content-section');
                const adminPasswordInput = document.getElementById('admin-password-input');
                const adminMessage = document.getElementById('admin-message');

                // Always show auth section and hide content when opening admin panel
                adminAuthSection.classList.remove('hidden');
                adminContentSection.classList.add('hidden');
                adminPasswordInput.value = ''; // Clear password input
                adminMessage.textContent = ''; // Clear message
            }

            panel.classList.toggle('active');

            if (panelId === 'contribution-panel' && panel.classList.contains('active')) {
                fetchContributions();
            }

            // Close other panels when one opens
            document.querySelectorAll('.panel').forEach(otherPanel => {
                if (otherPanel.id !== panelId) {
                    otherPanel.classList.remove('active');
                }
            });
        });
    });

    // Add event listener for the close buttons within panels
    document.querySelectorAll('.panel-close-btn').forEach(button => {
        button.addEventListener('click', () => {
            const panelId = button.getAttribute('data-panel');
            const panel = document.getElementById(panelId);
            panel.classList.remove('active');
        });
    });
}


// New function for private user authentication
function initPrivateUserAuth() {
    const privateUserFab = document.querySelector('#fab-private-user .fab');
    const privateUserPanel = document.getElementById('private-user-panel');
    const privateUserInput = document.getElementById('private-user-input');
    const privateUserSubmit = document.getElementById('private-user-submit');
    const privateUserMessage = document.getElementById('private-user-message');

    privateUserFab.addEventListener('click', () => {
        privateUserPanel.classList.toggle('active');
        // Close other panels when private user panel opens
        document.querySelectorAll('.panel').forEach(otherPanel => {
            if (otherPanel.id !== 'private-user-panel') {
                otherPanel.classList.remove('active');
            }
        });
        privateUserInput.value = ''; // Clear input on open
        privateUserMessage.textContent = ''; // Clear message on open
    });

    privateUserSubmit.addEventListener('click', async () => {
        const username = privateUserInput.value.trim().toLowerCase();
        if (username === '') {
            privateUserMessage.style.color = 'var(--danger)';
            privateUserMessage.textContent = 'Nama tidak boleh kosong!';
            return;
        }

        privateUserMessage.style.color = 'var(--text-secondary)';
        privateUserMessage.textContent = 'Memeriksa user...';

        try {
            const response = await fetch('https://private-user-auth.ezvvel.workers.dev/', { // Ganti dengan URL Cloudflare Worker Anda
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: username })
            });

            const data = await response.json();

            if (data.authenticated) {
                privateUserMessage.style.color = 'var(--success)';
                privateUserMessage.textContent = 'User terautentikasi! Mengarahkan...';
                setTimeout(() => {
                    window.location.href = data.redirectUrl;
                }, 1000);
            } else {
                privateUserMessage.style.color = 'var(--danger)';
                privateUserMessage.textContent = 'User tidak ada';
            }
        } catch (error) {
            console.error('Error during authentication:', error);
            privateUserMessage.style.color = 'var(--danger)';
            privateUserMessage.textContent = 'Terjadi kesalahan saat otentikasi.';
        }
    });
}
    
// MODIFIED: initLayoutAndThemeToggles to add alert for desktop layout
function initLayoutAndThemeToggles() {
    const layoutBtn = document.querySelector('#fab-layout .fab');
    const themeBtn = document.querySelector('#fab-theme .fab');
    const desktopLayoutBtn = document.getElementById('desktop-layout-toggle');
    const desktopThemeBtn = document.getElementById('desktop-theme-toggle');

    const toggleLayout = () => {
        if (!document.body.classList.contains('desktop-layout')) {
            alert('Silakan aktifkan "Situs Desktop" di browser Anda untuk pengalaman terbaik.');
        }
        document.body.classList.toggle('desktop-layout');
    };

    const toggleTheme = () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        document.querySelectorAll('#fab-theme i, #desktop-theme-toggle i').forEach(i => {
            i.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        });
    };

    layoutBtn.addEventListener('click', toggleLayout);
    desktopLayoutBtn.addEventListener('click', toggleLayout);
    themeBtn.addEventListener('click', toggleTheme);
    desktopThemeBtn.addEventListener('click', toggleTheme);
}

function initVideoPlayer() {
    const video = document.getElementById('widget-video');
    const playBtn = document.getElementById('video-play-pause');
    const muteBtn = document.getElementById('video-mute');

    playBtn.addEventListener('click', () => {
        if (video.paused) {
            video.play();
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
            video.pause();
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
    });
    muteBtn.addEventListener('click', () => {
        video.muted = !video.muted;
        muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
    });
}
function initMusicPlayer() {
    const player = document.getElementById('audio-player');
    const playlistEl = document.getElementById('playlist');
    const songTitleEl = document.getElementById('song-title');
    const songs = [
        { name: "Where We Are", url: "where-we-are.mp3" },
        { name: "Wish You Were Here", url: "wish-you-were-here.mp3" },
        { name: "ghost to you", url: "ghost-to-you.mp3" },
    ];
    songs.forEach((song, index) => {
        const item = document.createElement('div');
        item.textContent = song.name;
        item.style.cursor = 'pointer';
        item.style.padding = '8px';
        item.onclick = () => {
            player.src = song.url;
            songTitleEl.textContent = song.name;
            player.play();
        };
        playlistEl.appendChild(item);
    });
}
function initEditor() {
    const htmlEditor = document.getElementById('html-editor');
    const cssEditor = document.getElementById('css-editor');
    const jsEditor = document.getElementById('js-editor');
    const previewFrame = document.getElementById('editor-preview');
    const runCode = () => {
        const source = `
            <html>
                <head><style>${cssEditor.value}</style></head>
                <body>${htmlEditor.value}<script>${jsEditor.value}<\/script></body>
            </html>
        `;
        previewFrame.srcdoc = source;
    };
    const saveCode = () => {
        localStorage.setItem('editor_html', htmlEditor.value);
        localStorage.setItem('editor_css', cssEditor.value);
        localStorage.setItem('editor_js', jsEditor.value);
        alert('Code saved!');
    };
    const loadCode = () => {
        htmlEditor.value = localStorage.getItem('editor_html') || '';
        cssEditor.value = localStorage.getItem('editor_css') || '';
        jsEditor.value = localStorage.getItem('editor_js') || '';
        runCode();
    };
    const newDoc = () => {
        htmlEditor.value = '<h1>Hello World</h1>';
        cssEditor.value = 'h1 { color: blue; }';
        jsEditor.value = 'console.log("Hello from JS!");';
        runCode();
    };
    document.getElementById('editor-run').addEventListener('click', runCode);
    document.getElementById('editor-save').addEventListener('click', saveCode);
    document.getElementById('editor-load').addEventListener('click', loadCode);
    document.getElementById('editor-new').addEventListener('click', newDoc);
    document.getElementById('editor-add-media').addEventListener('click', () => {
        htmlEditor.value += '\n<img src="path/to/image.jpg" alt="image" width="100">';
    });
    loadCode();
}
async function fetchContributions() {
    const display = document.getElementById('contribution-display');
    display.innerHTML = `<p>Loading...</p>`;
    try {
        const response = await fetch(CONTRIBUTIONS_WORKER_URL);
        const contributions = await response.json();
        if (contributions && contributions.length > 0) {
            display.innerHTML = contributions.reverse().map(c => {
                let mediaHTML = '';
                if(c.fileUrl) {
                    if(c.fileType.startsWith('image/')) {
                        mediaHTML = `<img src="${c.fileUrl}" style="max-width:100%; border-radius:5px; margin-top:10px;">`;
                    } else if (c.fileType.startsWith('video/')) {
                        mediaHTML = `<video controls src="${c.fileUrl}" style="max-width:100%; border-radius:5px; margin-top:10px;"></video>`;
                    }
                }
                const timestamp = new Date(c.timestamp).toLocaleString();
                return `
                    <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid var(--border-color);">
                        <p style="margin:0; font-size:0.95em;">${c.message}</p>
                        ${mediaHTML}
                        <p style="font-size:0.75em; color:var(--text-secondary); margin-top:5px; text-align:right;">${timestamp}</p>
                    </div>
                `;
            }).join('');
        } else {
            display.innerHTML = `<p style="text-align:center;">No contributions yet.</p>`;
        }
    } catch (error) {
        console.error('Error fetching contributions:', error);
        display.innerHTML = `<p style="color:var(--danger); text-align:center;">Failed to load messages.</p>`;
    }
}
document.getElementById('contribution-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = document.getElementById('contribution-text').value;
    const fileInput = document.getElementById('contribution-file').files[0];
    const statusEl = document.getElementById('contribution-status');
    statusEl.textContent = 'Sending message...';
    statusEl.style.color = 'var(--text-secondary)';
    const formData = new FormData();
    formData.append('message', message);
    if (fileInput) {
        formData.append('file', fileInput);
    }
    try {
        const response = await fetch(CONTRIBUTIONS_WORKER_URL, {
            method: 'POST',
            body: formData,
        });
        const result = await response.json();
        if (result.success) {
            statusEl.style.color = 'var(--success)';
            statusEl.textContent = 'Message sent successfully!';
            document.getElementById('contribution-text').value = '';
            document.getElementById('contribution-file').value = '';
            fetchContributions(); // Reload contributions
        } else {
            statusEl.style.color = 'var(--danger)';
            statusEl.textContent = `Error: ${result.error || 'Failed to send message.'}`;
        }
    } catch (error) {
        console.error('Error sending contribution:', error);
        statusEl.style.color = 'var(--danger)';
        statusEl.textContent = 'Network error or server unavailable.';
    }
});

// NEW: Function to track visitor data
async function trackVisitor() {
    try {
        const referrer = document.referrer || 'Direct';
        const userAgent = navigator.userAgent;
        const browserId = generateBrowserId(); // Generate or retrieve a unique browser ID

        const data = {
            browserId: browserId,
            ip: '', // Will be filled by the Worker
            device: userAgent,
            referrer: referrer,
            timestamp: new Date().toISOString()
        };

        // Send data to the Cloudflare Worker
        await fetch(VISITOR_TRACKER_WORKER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        console.log('Visitor data sent to tracker worker.');
    } catch (error) {
        console.error('Error sending visitor data:', error);
    }
}

// Helper to generate/get a browser ID
function generateBrowserId() {
    let browserId = localStorage.getItem('browserId');
    if (!browserId) {
        browserId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        localStorage.setItem('browserId', browserId);
    }
    return browserId;
}

// NEW: Initialize Admin Panel
function initAdminPanel() {
    const adminFab = document.querySelector('#fab-admin .fab');
    const adminPanel = document.getElementById('admin-panel');
    const adminPasswordInput = document.getElementById('admin-password-input');
    const adminPasswordSubmit = document.getElementById('admin-password-submit');
    const adminMessage = document.getElementById('admin-message');
    const adminAuthSection = document.getElementById('admin-auth-section');
    const adminContentSection = document.getElementById('admin-content-section');
    const visitorList = document.getElementById('visitor-list');

    adminFab.addEventListener('click', () => {
        adminPanel.classList.toggle('active');
        // Close other panels
        document.querySelectorAll('.panel').forEach(otherPanel => {
            if (otherPanel.id !== 'admin-panel') {
                otherPanel.classList.remove('active');
            }
        });
        // Reset admin panel state
        adminAuthSection.classList.remove('hidden');
        adminContentSection.classList.add('hidden');
        adminPasswordInput.value = '';
        adminMessage.textContent = '';
    });

    adminPasswordSubmit.addEventListener('click', async () => {
        const password = adminPasswordInput.value.trim();
        if (password === '') {
            adminMessage.style.color = 'var(--danger)';
            adminMessage.textContent = 'Password tidak boleh kosong!';
            return;
        }

        adminMessage.style.color = 'var(--text-secondary)';
        adminMessage.textContent = 'Memeriksa password...';

        try {
            const response = await fetch(ADMIN_AUTH_WORKER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: password })
            });

            const data = await response.json();

            if (data.authenticated) {
                adminMessage.style.color = 'var(--success)';
                adminMessage.textContent = 'Password benar! Memuat data pengunjung...';
                adminAuthSection.classList.add('hidden');
                adminContentSection.classList.remove('hidden');
                fetchVisitorData(); // Fetch and display visitor data
            } else {
                adminMessage.style.color = 'var(--danger)';
                adminMessage.textContent = 'Password salah.';
            }
        } catch (error) {
            console.error('Error during admin authentication:', error);
            adminMessage.style.color = 'var(--danger)';
            adminMessage.textContent = 'Terjadi kesalahan saat otentikasi admin.';
        }
    });

    async function fetchVisitorData() {
        visitorList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading visitor data...</p>';
        try {
            const response = await fetch(LIVE_VISITORS_WORKER_URL);
            const visitors = await response.json();

            if (visitors && visitors.length > 0) {
                visitorList.innerHTML = ''; // Clear loading message
                visitors.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by most recent
                visitors.forEach(visitor => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <strong>ID:</strong> ${visitor.browserId.substring(0, 8)}...<br>
                        <strong>IP:</strong> ${visitor.ip}<br>
                        <strong>Perangkat:</strong> ${visitor.device}<br>
                        <strong>Referrer:</strong> ${visitor.referrer}<br>
                        <span>Masuk: ${new Date(visitor.timestamp).toLocaleString()}</span>
                    `;
                    visitorList.appendChild(listItem);
                });
            } else {
                visitorList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Tidak ada data pengunjung.</p>';
            }
        } catch (error) {
            console.error('Error fetching visitor data:', error);
            visitorList.innerHTML = '<p style="color:var(--danger); text-align:center;">Gagal memuat data pengunjung.</p>';
        }
    }
}

// ... (rest of your existing JavaScript)

</script>
</body>
</html>
