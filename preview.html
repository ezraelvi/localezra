<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Biometric Authentication</title>
  <link href="https://fonts.googleapis.com/css2?family=Courier+New&display=swap" rel="stylesheet">
</head>
<body>
<style>
    /* üé® WARNA KHUSUS UNTUKMU */
    :root {
      --glow: #00ff88;
      --dark: #0a0a12;
      --error: #ff0033;
      --scan-speed: 3s;
    }

    /* üñ•Ô∏è TAMPILAN UTAMA */
    body {
      background: radial-gradient(circle at center, #0a0a20, #000000);
      height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Courier New', monospace;
      color: var(--glow);
      overflow: hidden;
    }

    .container {
      width: 100%;
      max-width: 400px;
      text-align: center;
      position: relative;
    }

    /* SVG Container Styles */
    .svg-container {
      position: relative;
      margin: 0 auto 30px;
      width: 200px;
      height: 200px;
    }

    .svg-container svg {
      width: 100%;
      height: 100%;
      fill: var(--glow);
      opacity: 0.7;
    }

    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(to bottom, transparent, var(--glow), transparent);
      animation: scan var(--scan-speed) linear infinite;
      opacity: 0;
      z-index: 2;
    }

    @keyframes scan {
      0% { top: 0; opacity: 0; }
      5% { opacity: 1; }
      95% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }

    /* Status Text */
    .status {
      margin-top: 20px;
      font-size: 14px;
      text-shadow: 0 0 5px var(--glow);
      min-height: 20px;
    }

    /* IP Display */
    .ip-display {
      position: fixed;
      bottom: 20px;
      width: 100%;
      text-align: center;
      font-size: 12px;
      color: rgba(0, 255, 136, 0.7);
    }

    /* Buttons */
    .auth-btn {
      background: transparent;
      border: 1px solid var(--glow);
      color: var(--glow);
      padding: 8px 16px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s;
    }

    .auth-btn:hover {
      background: rgba(0, 255, 136, 0.1);
      box-shadow: 0 0 10px var(--glow);
    }

    .btn-container {
      margin-top: 20px;
      display: none;
    }

    /* Error State */
    .error-state {
      animation: error-pulse 0.8s infinite;
    }

    @keyframes error-pulse {
      0%, 100% { box-shadow: 0 0 10px var(--error); }
      50% { box-shadow: 0 0 30px var(--error); }
    }

    /* Login Form */
    .login-form {
      display: none;
      margin-top: 20px;
    }

    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
    }

    .form-group input {
      width: 100%;
      padding: 8px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--glow);
      color: var(--glow);
      border-radius: 4px;
    }
</style>
  <div class="container">
    <div class="svg-container">
      <!-- SVG placeholder - replace with your own SVG code -->
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <!-- Default fingerprint SVG - replace with your own -->
        <path d="M50 10 C60 10, 65 20, 60 30 C55 40, 45 40, 40 30 C35 20, 40 10, 50 10 Z" />
        <path d="M40 30 C35 40, 25 40, 20 30 C15 20, 20 10, 30 10 C40 10, 45 20, 40 30 Z" />
        <path d="M60 30 C65 40, 75 40, 80 30 C85 20, 80 10, 70 10 C60 10, 55 20, 60 30 Z" />
        <path d="M30 30 L30 70 C30 80, 40 90, 50 90 C60 90, 70 80, 70 70 L70 30" />
        <path d="M30 50 L20 50 C10 50, 10 60, 20 60 L30 60" />
        <path d="M70 50 L80 50 C90 50, 90 60, 80 60 L70 60" />
      </svg>
      <div class="scan-line" id="scanLine"></div>
    </div>
    <div class="status" id="status">INITIALIZING BIOMETRIC SYSTEM...</div>
    
    <div class="btn-container" id="btnContainer">
      <button class="auth-btn" id="fallbackBtn">USE EMAIL LOGIN</button>
      <button class="auth-btn" id="visitBtn">VISIT DASHBOARD</button>
      <button class="auth-btn" id="webauthnBtn">CHECK WEBAUTHN SUPPORT</button>
    </div>
    
    <div class="login-form" id="loginForm">
      <div class="form-group">
        <label for="email">EMAIL:</label>
        <input type="email" id="email" required>
      </div>
      <div class="form-group">
        <label for="password">PASSWORD:</label>
        <input type="password" id="password" required>
      </div>
      <button class="auth-btn" id="submitLogin">SUBMIT</button>
    </div>
    
    <div class="ip-display" id="ipDisplay">Detecting your IP...</div>
  </div>

<script>
// Configuration
const config = {
  supabaseUrl: 'https://hjmosjvfrycamxowfurq.supabase.co',
  supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqbW9zanZmcnljYW14b3dmdXJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTU1MTQsImV4cCI6MjA2NDQzMTUxNH0.8KNrzHleB62I4x7kjF-aR41vAmbbpJLgAkhhcZVwSSM',
  maxAttempts: 3,
  cloudflareEndpoint: 'https://your-worker-name.your-account.workers.dev',
  dashboardUrl: 'dashboard.html',
  lockdownUrl: 'whoareyou/index.html',
  webauthnSupportUrl: 'https://webauthn.me/browser-support'
};

// DOM Elements
const elements = {
  scanLine: document.getElementById('scanLine'),
  status: document.getElementById('status'),
  ipDisplay: document.getElementById('ipDisplay'),
  visitBtn: document.getElementById('visitBtn'),
  fallbackBtn: document.getElementById('fallbackBtn'),
  webauthnBtn: document.getElementById('webauthnBtn'),
  btnContainer: document.getElementById('btnContainer'),
  loginForm: document.getElementById('loginForm'),
  emailInput: document.getElementById('email'),
  passwordInput: document.getElementById('password'),
  submitLogin: document.getElementById('submitLogin'),
  container: document.querySelector('.container')
};

// State
let state = {
  isScanning: false,
  isLocked: false,
  attemptCount: 0,
  audioCtx: null,
  supabase: null,
  userIp: null,
  browserId: null,
  deviceInfo: null
};

// Audio functions
function initAudio() {
  try {
    state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  } catch (e) {
    console.error('Web Audio API not supported');
  }
}

function playBeep(type) {
  if (!state.audioCtx) return;
  
  const oscillator = state.audioCtx.createOscillator();
  const gainNode = state.audioCtx.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(state.audioCtx.destination);
  
  oscillator.type = 'sine';
  
  switch(type) {
    case 'scan':
      oscillator.frequency.value = 800;
      break;
    case 'success':
      oscillator.frequency.value = 1200;
      break;
    case 'error':
      oscillator.frequency.value = 400;
      break;
    case 'fail':
      oscillator.frequency.value = 300;
      break;
  }
  
  gainNode.gain.exponentialRampToValueAtTime(0.1, state.audioCtx.currentTime + 0.1);
  oscillator.start();
  oscillator.stop(state.audioCtx.currentTime + 0.3);
}

// Device and browser info
function generateBrowserId() {
  let id = localStorage.getItem('browserId');
  if (!id) {
    id = 'id-' + Math.random().toString(36).substr(2, 9) + 
         '-' + Date.now().toString(36);
    localStorage.setItem('browserId', id);
  }
  state.browserId = id;
  return id;
}

function collectDeviceInfo() {
  state.deviceInfo = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
    deviceMemory: navigator.deviceMemory || 'unknown',
    screenResolution: `${window.screen.width}x${window.screen.height}`,
    colorDepth: window.screen.colorDepth,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    browserId: state.browserId,
    timestamp: new Date().toISOString()
  };
  return state.deviceInfo;
}

// WebAuthn and fingerprint support detection
function isWebAuthnSupported() {
  return window.PublicKeyCredential !== undefined && 
         typeof PublicKeyCredential === 'function' &&
         typeof PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable === 'function';
}

function isFingerprintSupported() {
  if (!isWebAuthnSupported()) return false;
  
  return PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
    .then(available => available)
    .catch(() => false);
}

// Authentication functions
function startFingerprintDetection() {
  if (state.isLocked) return;
  
  elements.status.textContent = "SCANNING FINGERPRINT...";
  elements.scanLine.style.opacity = '1';
  state.isScanning = true;
  playBeep('scan');
  
  // Simulate fingerprint scan (replace with actual WebAuthn implementation)
  setTimeout(() => {
    authenticateWithFingerprint();
  }, 3000);
}

function authenticateWithFingerprint() {
  isFingerprintSupported().then(supported => {
    if (!supported) {
      handleFingerprintUnsupported();
      return;
    }
    
    // Here you would normally use the WebAuthn API
    // This is just a simulation
    const isAuthenticated = Math.random() > 0.3; // 70% success rate for demo
    
    if (isAuthenticated) {
      handleAuthSuccess();
    } else {
      handleAuthFailure();
    }
  }).catch(() => {
    handleFingerprintUnsupported();
  });
}

function handleAuthSuccess() {
  state.isScanning = false;
  elements.scanLine.style.opacity = '0';
  elements.status.textContent = "AUTHENTICATION SUCCESSFUL";
  playBeep('success');
  
  // Show visit button
  elements.btnContainer.style.display = 'block';
  elements.visitBtn.style.display = 'inline-block';
  elements.fallbackBtn.style.display = 'none';
  elements.webauthnBtn.style.display = 'none';
  
  // Log successful authentication
  logAuthAttempt(true);
}

function handleAuthFailure() {
  state.attemptCount++;
  state.isScanning = false;
  elements.scanLine.style.opacity = '0';
  
  if (state.attemptCount >= config.maxAttempts) {
    handleLockout();
    return;
  }
  
  elements.status.textContent = `AUTHENTICATION FAILED (${state.attemptCount}/${config.maxAttempts})`;
  playBeep('fail');
  
  // Show buttons
  elements.btnContainer.style.display = 'block';
  elements.fallbackBtn.style.display = 'inline-block';
  elements.visitBtn.style.display = 'none';
  elements.webauthnBtn.style.display = 'inline-block';
  
  // Log failed attempt
  logAuthAttempt(false);
  
  // Retry after delay
  setTimeout(() => {
    if (!state.isLocked) {
      startFingerprintDetection();
    }
  }, 2000);
}

function handleFingerprintUnsupported() {
  state.isScanning = false;
  elements.scanLine.style.opacity = '0';
  elements.status.textContent = "FINGERPRINT AUTHENTICATION NOT SUPPORTED";
  playBeep('error');
  
  // Show fallback options
  elements.btnContainer.style.display = 'block';
  elements.fallbackBtn.style.display = 'inline-block';
  elements.webauthnBtn.style.display = 'inline-block';
  elements.visitBtn.style.display = 'none';
}

function handleWebAuthnUnsupported() {
  elements.status.textContent = "WEBAUTHN NOT SUPPORTED BY YOUR BROWSER";
  playBeep('error');
  
  // Show fallback options
  elements.btnContainer.style.display = 'block';
  elements.fallbackBtn.style.display = 'inline-block';
  elements.webauthnBtn.style.display = 'inline-block';
  elements.visitBtn.style.display = 'none';
}

function handleLockout() {
  state.isLocked = true;
  elements.container.classList.add('error-state');
  elements.status.textContent = "TOO MANY FAILED ATTEMPTS. ACCESS DENIED.";
  playBeep('fail');
  
  // Set cookie to block future attempts
  document.cookie = "blocked=true; max-age=3600; path=/";
  
  // Redirect after delay
  setTimeout(() => {
    window.location.href = config.lockdownUrl;
  }, 3000);
}

// Fallback login
function showLoginForm() {
  elements.loginForm.style.display = 'block';
  elements.btnContainer.style.display = 'none';
  elements.status.textContent = "PLEASE ENTER YOUR CREDENTIALS";
}

async function submitLogin() {
  const email = elements.emailInput.value;
  const password = elements.passwordInput.value;
  
  if (!email || !password) {
    elements.status.textContent = "PLEASE ENTER BOTH EMAIL AND PASSWORD";
    playBeep('error');
    return;
  }
  
  elements.status.textContent = "VERIFYING CREDENTIALS...";
  
  // Here you would normally verify with your backend
  // This is just a simulation
  setTimeout(() => {
    const isAuthenticated = Math.random() > 0.5; // 50% success rate for demo
    
    if (isAuthenticated) {
      handleAuthSuccess();
    } else {
      elements.status.textContent = "INVALID CREDENTIALS";
      playBeep('fail');
    }
  }, 1500);
}

// Utility functions
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

async function detectIp() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    state.userIp = data.ip;
    elements.ipDisplay.textContent = `IP: ${data.ip} | ${new Date().toLocaleString()}`;
  } catch (error) {
    console.error('IP detection failed:', error);
    elements.ipDisplay.textContent = 'IP: Unknown | ' + new Date().toLocaleString();
  }
}

function logAuthAttempt(success) {
  const data = {
    success,
    browserId: state.browserId,
    ip: state.userIp,
    timestamp: new Date().toISOString(),
    deviceInfo: collectDeviceInfo()
  };
  
  // Here you would send this to your backend or Cloudflare worker
  console.log('Auth attempt:', data);
  
  // Example of sending to Cloudflare worker
  // fetch(config.cloudflareEndpoint, {
  //   method: 'POST',
  //   headers: { 'Content-Type': 'application/json' },
  //   body: JSON.stringify(data)
  // });
}

// Event listeners
function setupEventListeners() {
  elements.fallbackBtn.addEventListener('click', showLoginForm);
  elements.visitBtn.addEventListener('click', () => {
    window.location.href = config.dashboardUrl;
  });
  elements.webauthnBtn.addEventListener('click', () => {
    window.open(config.webauthnSupportUrl, '_blank');
  });
  elements.submitLogin.addEventListener('click', submitLogin);
  
  // Also allow form submission with Enter key
  elements.passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      submitLogin();
    }
  });
}

// Initialize the application
async function init() {
  try {
    // Check if already locked out
    if (getCookie('blocked') === 'true') {
      window.location.href = config.lockdownUrl;
      return;
    }
    
    initAudio();
    await detectIp();
    generateBrowserId();
    collectDeviceInfo();
    
    // Check device capabilities
    if (!isWebAuthnSupported()) {
      handleWebAuthnUnsupported();
      return;
    }
    
    // Setup event listeners
    setupEventListeners();
    
    // Start fingerprint detection
    startFingerprintDetection();
    
  } catch (error) {
    console.error('Initialization error:', error);
    elements.status.textContent = "SYSTEM INITIALIZATION FAILED";
    elements.btnContainer.style.display = 'block';
    elements.fallbackBtn.style.display = 'inline-block';
    elements.webauthnBtn.style.display = 'inline-block';
    playBeep('error');
  }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
