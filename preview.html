<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Biometric Authentication</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
</head>
<body>
<style>
/* Base Styles */
:root {
  --primary: #00ff88;
  --error: #ff0033;
  --background: #000000;
  --text: #00ff88;
  --warning: #ffcc00;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background-color: var(--background);
  color: var(--text);
  font-family: 'Share Tech Mono', monospace;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.container {
  width: 100%;
  max-width: 400px;
  text-align: center;
  position: relative;
  padding: 20px;
}

/* SVG Container Styles */
.svg-container {
  position: relative;
  margin: 0 auto 30px;
  width: 200px;
  height: 200px;
}

.svg-placeholder {
  width: 100%;
  height: 100%;
  fill: var(--primary);
  opacity: 0.7;
}

.scan-line {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(to bottom, transparent, var(--primary), transparent);
  animation: scan 3s linear infinite;
  opacity: 0;
  z-index: 2;
}

@keyframes scan {
  0% { top: 0; opacity: 0; }
  5% { opacity: 1; }
  95% { opacity: 1; }
  100% { top: 100%; opacity: 0; }
}

/* Status Text */
.status {
  margin-top: 20px;
  font-size: 14px;
  text-shadow: 0 0 5px var(--primary);
  min-height: 20px;
}

/* IP Display */
.ip-display {
  position: fixed;
  bottom: 20px;
  width: 100%;
  text-align: center;
  font-size: 12px;
  color: rgba(0, 255, 136, 0.7);
}

/* Buttons */
.auth-btn {
  background: transparent;
  border: 1px solid var(--primary);
  color: var(--primary);
  padding: 8px 16px;
  border-radius: 4px;
  font-family: 'Share Tech Mono', monospace;
  cursor: pointer;
  transition: all 0.3s;
  margin: 10px 5px;
  display: inline-block;
}

.auth-btn:hover {
  background: rgba(0, 255, 136, 0.1);
  box-shadow: 0 0 10px var(--primary);
}

.btn-container {
  margin-top: 20px;
  display: none;
}

/* Error State */
.error-state {
  animation: error-pulse 0.8s infinite;
}

@keyframes error-pulse {
  0%, 100% { box-shadow: 0 0 10px var(--error); }
  50% { box-shadow: 0 0 30px var(--error); }
}

.warning-text {
  color: var(--warning);
  margin: 15px 0;
}

/* Login Form */
.login-form {
  display: none;
  margin-top: 20px;
  text-align: left;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-size: 12px;
}

.form-group input {
  width: 100%;
  padding: 8px;
  background: rgba(0, 0, 0, 0.5);
  border: 1px solid var(--primary);
  color: var(--text);
  font-family: 'Share Tech Mono', monospace;
}

/* Device Info */
.device-info {
  font-size: 10px;
  color: rgba(0, 255, 136, 0.5);
  margin-top: 30px;
  text-align: left;
}
</style>
  <div class="container">
    <div class="svg-container">
      <!-- SVG placeholder - replace with your own SVG code -->
      <svg class="svg-placeholder" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <!-- Default simple fingerprint icon - replace with your SVG -->
        <path d="M50 10 A20 20 0 0 1 50 50 A20 20 0 0 1 50 90 M30 30 A20 20 0 0 1 70 30 M30 70 A20 20 0 0 0 70 70"/>
      </svg>
      <div class="scan-line" id="scanLine"></div>
    </div>
    
    <div class="status" id="status">INITIALIZING BIOMETRIC SYSTEM...</div>
    
    <div class="btn-container" id="btnContainer">
      <button class="auth-btn" id="fallbackBtn">USE EMAIL LOGIN</button>
      <button class="auth-btn" id="retryBtn">RETRY BIOMETRIC</button>
    </div>
    
    <div class="login-form" id="loginForm">
      <div class="form-group">
        <label for="email">EMAIL:</label>
        <input type="email" id="email" placeholder="your@email.com">
      </div>
      <div class="form-group">
        <label for="password">PASSWORD:</label>
        <input type="password" id="password" placeholder="••••••••">
      </div>
      <button class="auth-btn" id="loginBtn">LOGIN</button>
    </div>
    
    <div class="device-info" id="deviceInfo">
      <!-- Device info will be populated here -->
    </div>
    
    <div class="ip-display" id="ipDisplay">Detecting your IP...</div>
  </div>

<script>
// Configuration
const config = {
  supabaseUrl: 'https://hjmosjvfrycamxowfurq.supabase.co',
  supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhqbW9zanZmcnljYW14b3dmdXJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4NTU1MTQsImV4cCI6MjA2NDQzMTUxNH0.8KNrzHleB62I4x7kjF-aR41vAmbbpJLgAkhhcZVwSSM',
  maxAttempts: 3,
  cloudflareEndpoint: 'https://your-worker-name.your-account.workers.dev',
  dashboardUrl: 'dashboard.html',
  lockdownUrl: 'whoareyou/index.html',
  webauthnSupportUrl: 'https://webauthn.me/browser-support'
};

// DOM Elements
const elements = {
  scanLine: document.getElementById('scanLine'),
  status: document.getElementById('status'),
  ipDisplay: document.getElementById('ipDisplay'),
  btnContainer: document.getElementById('btnContainer'),
  fallbackBtn: document.getElementById('fallbackBtn'),
  retryBtn: document.getElementById('retryBtn'),
  loginForm: document.getElementById('loginForm'),
  emailInput: document.getElementById('email'),
  passwordInput: document.getElementById('password'),
  loginBtn: document.getElementById('loginBtn'),
  deviceInfo: document.getElementById('deviceInfo'),
  container: document.querySelector('.container')
};

// State
let state = {
  isScanning: false,
  isLocked: false,
  attemptCount: 0,
  audioCtx: null,
  supabase: null,
  userIp: null,
  browserId: null,
  deviceInfo: null,
  hasFingerprintSupport: false,
  hasWebAuthnSupport: false
};

// Initialize the application
async function init() {
  try {
    // Check if already locked out
    if (getCookie('blocked') === 'true') {
      window.location.href = config.lockdownUrl;
      return;
    }

    // Initialize services
    initSupabase();
    
    // Check device capabilities
    state.hasWebAuthnSupport = isWebAuthnSupported();
    state.hasFingerprintSupport = await checkFingerprintSupport();
    
    if (!state.hasWebAuthnSupport) {
      handleWebAuthnUnsupported();
      return;
    }
    
    if (!state.hasFingerprintSupport) {
      handleFingerprintUnsupported();
      return;
    }
    
    initAudio();
    await detectIp();
    generateBrowserId();
    collectDeviceInfo();
    updateDeviceInfoDisplay();
    
    // Setup event listeners
    setupEventListeners();
    
    // Start fingerprint detection
    startFingerprintDetection();
    
  } catch (error) {
    console.error('Initialization error:', error);
    handleInitError(error);
  }
}

function handleInitError(error) {
  elements.status.textContent = "SYSTEM INITIALIZATION FAILED";
  showButtons();
  
  // Log error to Cloudflare
  sendToCloudflare('init_error', {
    error: error.message,
    stack: error.stack,
    deviceInfo: state.deviceInfo
  });
}

function handleWebAuthnUnsupported() {
  elements.status.innerHTML = `<span class="warning-text">WEB AUTHENTICATION API NOT SUPPORTED</span>`;
  elements.btnContainer.style.display = 'block';
  elements.fallbackBtn.style.display = 'none';
  elements.retryBtn.textContent = "CHECK BROWSER SUPPORT";
  elements.retryBtn.onclick = () => window.open(config.webauthnSupportUrl, '_blank');
  
  sendToCloudflare('webauthn_unsupported', {
    deviceInfo: state.deviceInfo
  });
}

function handleFingerprintUnsupported() {
  elements.status.innerHTML = `<span class="warning-text">FINGERPRINT SENSOR NOT AVAILABLE</span>`;
  showButtons();
  
  sendToCloudflare('fingerprint_unsupported', {
    deviceInfo: state.deviceInfo
  });
}

function showButtons() {
  elements.btnContainer.style.display = 'block';
  elements.fallbackBtn.onclick = showLoginForm;
  elements.retryBtn.onclick = retryBiometric;
}

function showLoginForm() {
  elements.loginForm.style.display = 'block';
  elements.btnContainer.style.display = 'none';
  elements.status.textContent = "PLEASE ENTER YOUR CREDENTIALS";
  
  // Set up login button
  elements.loginBtn.onclick = handleEmailLogin;
}

function retryBiometric() {
  elements.loginForm.style.display = 'none';
  elements.btnContainer.style.display = 'none';
  elements.status.textContent = "WAITING FOR FINGERPRINT...";
  startFingerprintDetection();
}

async function handleEmailLogin() {
  const email = elements.emailInput.value;
  const password = elements.passwordInput.password;
  
  if (!email || !password) {
    elements.status.innerHTML = `<span class="warning-text">PLEASE ENTER BOTH EMAIL AND PASSWORD</span>`;
    return;
  }
  
  elements.status.textContent = "AUTHENTICATING...";
  
  try {
    // Send credentials to Cloudflare worker
    const response = await fetch(config.cloudflareEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        email,
        password,
        deviceInfo: state.deviceInfo,
        browserId: state.browserId,
        ip: state.userIp
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Successful login
      elements.status.textContent = "AUTHENTICATION SUCCESSFUL!";
      window.location.href = config.dashboardUrl;
    } else {
      // Failed login
      elements.status.innerHTML = `<span class="warning-text">LOGIN FAILED: ${result.message || 'Invalid credentials'}</span>`;
    }
  } catch (error) {
    console.error('Login error:', error);
    elements.status.innerHTML = `<span class="warning-text">LOGIN ERROR: ${error.message}</span>`;
  }
}

function initSupabase() {
  // Initialize Supabase client
  state.supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);
}

async function checkSupabaseConnection() {
  try {
    const { data, error } = await state.supabase.from('test').select('*').limit(1);
    return !error;
  } catch (e) {
    return false;
  }
}

function initAudio() {
  try {
    state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  } catch (e) {
    console.warn('Web Audio API not supported');
  }
}

async function detectIp() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    state.userIp = data.ip;
    elements.ipDisplay.textContent = `IP: ${state.userIp}`;
  } catch (error) {
    console.error('IP detection failed:', error);
    state.userIp = 'unknown';
    elements.ipDisplay.textContent = `IP: Detection failed`;
  }
}

function generateBrowserId() {
  // Generate a persistent browser ID using localStorage
  if (!localStorage.getItem('browserId')) {
    const id = 'id-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now().toString(36);
    localStorage.setItem('browserId', id);
  }
  state.browserId = localStorage.getItem('browserId');
}

function collectDeviceInfo() {
  state.deviceInfo = {
    browserId: state.browserId,
    timestamp: new Date().toISOString(),
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    screenWidth: window.screen.width,
    screenHeight: window.screen.height,
    colorDepth: window.screen.colorDepth,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    languages: navigator.languages,
    cookieEnabled: navigator.cookieEnabled,
    doNotTrack: navigator.doNotTrack,
    hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
    deviceMemory: navigator.deviceMemory || 'unknown',
    touchSupport: 'ontouchstart' in window,
    webAuthnSupport: state.hasWebAuthnSupport,
    fingerprintSupport: state.hasFingerprintSupport
  };
}

function updateDeviceInfoDisplay() {
  const info = state.deviceInfo;
  elements.deviceInfo.innerHTML = `
    <div>Browser ID: ${info.browserId}</div>
    <div>Timestamp: ${new Date(info.timestamp).toLocaleString()}</div>
    <div>Platform: ${info.platform}</div>
    <div>Screen: ${info.screenWidth}x${info.screenHeight}</div>
    <div>WebAuthn: ${info.webAuthnSupport ? 'Supported' : 'Unsupported'}</div>
    <div>Fingerprint: ${info.fingerprintSupport ? 'Supported' : 'Unsupported'}</div>
  `;
}

function isWebAuthnSupported() {
  return !!window.PublicKeyCredential && 
         typeof PublicKeyCredential !== 'undefined' && 
         typeof window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable === 'function';
}

async function checkFingerprintSupport() {
  if (!isWebAuthnSupported()) return false;
  
  try {
    return await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
  } catch (e) {
    return false;
  }
}

function startFingerprintDetection() {
  if (state.isScanning || state.isLocked) return;
  
  state.isScanning = true;
  elements.scanLine.style.opacity = '1';
  elements.status.textContent = "SCANNING FINGERPRINT...";
  
  // Simulate fingerprint scan (in a real app, this would use WebAuthn API)
  setTimeout(() => {
    simulateFingerprintScan();
  }, 3000);
}

function simulateFingerprintScan() {
  state.isScanning = false;
  elements.scanLine.style.opacity = '0';
  
  // Random success/failure for demo purposes
  const isSuccess = Math.random() > 0.3;
  
  if (isSuccess) {
    handleSuccess();
  } else {
    handleFailure();
  }
}

function handleSuccess() {
  elements.status.textContent = "AUTHENTICATION SUCCESSFUL!";
  playSuccessSound();
  
  // Redirect to dashboard after delay
  setTimeout(() => {
    window.location.href = config.dashboardUrl;
  }, 1000);
}

function handleFailure() {
  state.attemptCount++;
  playErrorSound();
  
  if (state.attemptCount >= config.maxAttempts) {
    // Too many attempts - lock out
    elements.status.innerHTML = `<span class="warning-text">TOO MANY ATTEMPTS - SYSTEM LOCKED</span>`;
    setCookie('blocked', 'true', 1); // Block for 1 day
    setTimeout(() => {
      window.location.href = config.lockdownUrl;
    }, 2000);
  } else {
    // Show retry options
    elements.status.innerHTML = `<span class="warning-text">AUTHENTICATION FAILED (${state.attemptCount}/${config.maxAttempts})</span>`;
    showButtons();
  }
  
  // Log failed attempt
  sendToCloudflare('auth_failed', {
    attempt: state.attemptCount,
    deviceInfo: state.deviceInfo
  });
}

function playSuccessSound() {
  if (!state.audioCtx) return;
  
  const oscillator = state.audioCtx.createOscillator();
  const gainNode = state.audioCtx.createGain();
  
  oscillator.type = 'sine';
  oscillator.frequency.value = 880;
  gainNode.gain.value = 0.1;
  
  oscillator.connect(gainNode);
  gainNode.connect(state.audioCtx.destination);
  
  oscillator.start();
  gainNode.gain.exponentialRampToValueAtTime(0.01, state.audioCtx.currentTime + 0.5);
  oscillator.stop(state.audioCtx.currentTime + 0.5);
}

function playErrorSound() {
  if (!state.audioCtx) return;
  
  const oscillator = state.audioCtx.createOscillator();
  const gainNode = state.audioCtx.createGain();
  
  oscillator.type = 'sine';
  oscillator.frequency.value = 220;
  gainNode.gain.value = 0.1;
  
  oscillator.connect(gainNode);
  gainNode.connect(state.audioCtx.destination);
  
  oscillator.start();
  gainNode.gain.exponentialRampToValueAtTime(0.01, state.audioCtx.currentTime + 0.3);
  oscillator.stop(state.audioCtx.currentTime + 0.3);
}

function setupEventListeners() {
  // Add any additional event listeners here
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

function setCookie(name, value, days) {
  const date = new Date();
  date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
  document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
}

async function sendToCloudflare(eventType, data) {
  try {
    await fetch(config.cloudflareEndpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        eventType,
        ...data,
        timestamp: new Date().toISOString()
      })
    });
  } catch (error) {
    console.error('Error sending to Cloudflare:', error);
  }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
